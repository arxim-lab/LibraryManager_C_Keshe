/* 创建用户组结构体 * * 使用方法：用户组变量名 = usergroup_create(用户组名,权限码); */UserGroup * usergroup_create(char *gname,int code){    UserGroup * group;    group = (UserGroup*)malloc(sizeof(UserGroup));    group->gname = string_trans(gname);    group->permission[0] = read_mask(code,0);    group->permission[1] = read_mask(code,1);    group->permission[2] = read_mask(code,2);    group->permission[3] = read_mask(code,3);    return group;}/* 用户组链表初始化 * * 使用方法：用户组链表 = result_usergroup_init(); */UserGroup_result * result_usergroup_init(){    UserGroup_result *p1;    p1 = (UserGroup_result*)malloc(sizeof(UserGroup_result));    p1->u = NULL;    p1->n = NULL;    return p1;}/* 用户组链表销毁 * * 使用方法：result_usergroup_delete(用户组链表名); */void result_usergroup_delete(UserGroup_result * init){    UserGroup_result * p;    while(init!=NULL){        p = init;        init=init->n;        free(p);        p = NULL;    }}/* 获取特定用户组记录 * SELECT * FROM usergroup WHERE gid = ******; * SELECT * FROM usergroup WHERE gname = '******' ; * 支持ID和用户组名两种查找方式，不支持同时查询,优先使用ID查询 * * 使用方法：用户组名 = usergroup_get(用户组ID,用户组名); */UserGroup * usergroup_get(int gid,char *gname){    int rc;    char *sql_;    UserGroup_result * data;    UserGroup * output;    data = result_usergroup_init();    if(gid!=0) {        sql_ = str_cat("SELECT * FROM usergroup WHERE gid = ",num_to_str(gid), ";", NULL);        rc = db_exec(sql_, call_usergroup, data);        if(!rc) return NULL;    }else if(gname!=NULL){        sql_ = str_cat("SELECT * FROM usergroup WHERE gname = '",gname, "' ;", NULL);        rc = db_exec(sql_, call_usergroup, data);        if(!rc) return NULL;    }else        return NULL;    if(data->u==NULL) return NULL;    output = (UserGroup*)malloc(sizeof(UserGroup));    output->gid = data->u->gid;    output->gname = string_trans(data->u->gname);    output->permission[0] = data->u->permission[0];    output->permission[1] = data->u->permission[1];    output->permission[2] = data->u->permission[2];    output->permission[3] = data->u->permission[3];    result_usergroup_delete(data);    return output;}/* 检查用户组是否存在 * * 使用方法：usergroup_check(用户组ID); */int usergroup_check(int gid){    UserGroup * rc;    rc = usergroup_get(gid,NULL);    if(!rc) return false;    else return true;}/* 创建用户组记录 * INSERT INTO usergroup (gname,permission) VALUES(******); * * 使用方法：usergroup_sql_create(用户组变量名); */int usergroup_sql_create(UserGroup *new_g){    if(!ua.Allow_Manage_User_Group)        return -1;    int rc;    char *permission_,*sql_;    if(usergroup_check(usergroup_get(0,new_g->gname)->gid)) return 2;    permission_ = num_to_str(write_mask(new_g->permission));    sql_ = str_cat("INSERT INTO usergroup(gname,permission) VALUES('",new_g->gname,"',",permission_,");",NULL);    rc = db_exec(sql_,0,0);    if(!rc) return 0;    new_g->gid = usergroup_get(0,new_g->gname)->gid;    return rc;}/* 修改用户组记录 * UPDATE usergroup SET ****** = '******' WHERE gid = ******; * ！不要改就传0就行 * * 使用方法：usergroup_sql_edit(用户组ID,要改的名字,要改的权限码); */int usergroup_sql_edit(int gid,char *gname,int permission){    if(!ua.Allow_Manage_User_Group)        return -1;    char *permission_,*sql_;    int rc;    if(!usergroup_check(gid)) return 3;    if(usergroup_get(0,gname)!=NULL) return 2;    permission_ = num_to_str(permission);    if(gname!=NULL){        sql_ = str_cat("UPDATE usergroup SET gname = '",gname,"' WHERE gid = ",num_to_str(gid),";",NULL);        rc = db_exec(sql_,0,0);        if(!rc) return 0;    }    if(permission!=0){        sql_ = str_cat("UPDATE usergroup SET permission = ",permission_," WHERE gid = ",num_to_str(gid),";",NULL);        rc = db_exec(sql_,0,0);        if(!rc) return 0;    }    return 1;}/* 删除用户组记录 * DELETE FROM usergroup WHERE gid = ******; * * 使用方法：usergroup_sql_delete(用户组ID); */int usergroup_sql_delete(int gid){    if(!ua.Allow_Manage_User_Group)        return -1;    char *sql_;    if(!usergroup_check(gid)) return 3;    sql_ = str_cat("DELETE FROM usergroup WHERE gid = ",num_to_str(gid),";",NULL);    return db_exec(sql_,0,0);}/* 展示用户组记录（遍历） * 传入变量需要初始化/ * * 使用方法：usergroup_sql_query(用户组链表名); */int usergroup_sql_query(UserGroup_result *result){//    if(!ua.Allow_Manage_User_Group) return -1;    int rc;    rc = db_exec("SELECT * FROM usergroup;",call_usergroup,result);    return rc;}/* 创建用户结构体 * * 使用方法：用户变量名 = user_create(用户名,权限码,学号,是否为男); */User * user_create(char *_uname,int _gid,int _sid,bool _ismale){    User * output;    output = (User*)malloc(sizeof(User));    output->uname = string_trans(_uname);    output->gid = _gid;    output->sid = _sid;    output->IsMale = _ismale;    output->mask[0] = 0;    output->mask[1] = 0;    output->mask[2] = 0;    output->mask[3] = 0;    output->permission[0] = usergroup_get(_gid,NULL)->permission[0];    output->permission[1] = usergroup_get(_gid,NULL)->permission[1];    output->permission[2] = usergroup_get(_gid,NULL)->permission[2];    output->permission[3] = usergroup_get(_gid,NULL)->permission[3];    output->reg_time = tm_getnow();    return output;}/* 用户链表初始化 * * 使用方法：用户链表 = result_user_init(); */User_result * result_user_init(){    User_result *p1;    p1 = (User_result*)malloc(sizeof(User_result));    p1->u = NULL;    p1->n = NULL;    return p1;}/* 用户链表销毁 * * 使用方法：result_user_delete(用户链表名); */void result_user_delete(User_result * init){    User_result * p;    while(init!=NULL){        p = init;        init=init->n;        free(p);        p = NULL;    }}/* 按学号初选用户记录 * * 使用方法：用户链表名 = user_query(学号); */User_result * user_query(int sid){    int rc;    char *sql_;    User_result * data;    data = result_user_init();    sql_ = str_cat("SELECT * FROM user WHERE sid = ",num_to_str(sid)," ;",NULL);    rc = db_exec(sql_,call_user,data);    if(!rc) return NULL;    if(data->u==NULL) return NULL;    return data;}/* 根据初选结果选出特定用户记录 * 可通过用户ID直接获取用户信息，也可通过初选得到的链表进行二次筛选获得 * * 使用方法：用户变量名 = user_get(用户ID,用户链表名,用户组ID); */User * user_get(int uid,User_result *query_,int gid){    int rc;    char *sql_;    User_result * data;    if(uid!=0){        data = result_user_init();        sql_ = str_cat("SELECT * FROM user WHERE uid = ",num_to_str(uid), " ;", NULL);        rc = db_exec(sql_,call_user,data);        if(!rc) return NULL;        if(data->u==NULL) return NULL;        return data->u;    }    data = query_;    for(;data->n!=NULL;data=data->n)        if(data->u->gid==gid) break;    return data->u;}/* 检查用户是否存在 * * 使用方法：user_check(用户ID); */int user_check(int uid){    User * rc;    rc = user_get(uid,NULL,0);    if(!rc) return false;    else return true;}/* 创建用户记录 * INSERT INTO user (uname,gid,password,sid,reg_time) VALUES(******); * * 使用方法：user_sql_create(用户变量名,密码); */int user_sql_create(User *new_u,char * pwd){    if(!ua.Allow_Manage_Other_User_info||!ua.Allow_User_info_Write)        return -1;    int rc;    char *pwd_encrypted,*sql_,*gid_,*sid_,*reg_time_;//--BEGIN- 同用户组下用户的重复检查    User_result * check;    check = user_query(new_u->sid);    if(check==NULL) ;    else if(user_get(0,check,new_u->gid)) return 4;//---END-- 同用户组下用户的重复检查    pwd_encrypted = xor_crypt(pwd,KEY);    gid_ = num_to_str(new_u->gid);    sid_ = num_to_str(new_u->sid);    reg_time_ = num_to_str(mktime(new_u->reg_time));    sql_ = str_cat("INSERT INTO user (uname,gid,password,sid,reg_time) VALUES('",new_u->uname,"',",gid_,",'",pwd_encrypted,"',",sid_,",",reg_time_,");",NULL);    rc = db_exec(sql_,0,0);    if(!rc) return 0;    result_user_delete(check);    check = user_query(new_u->sid);    new_u->uid = user_get(0,check,new_u->gid)->uid;    if(new_u->IsMale)        sql_ = str_cat("UPDATE user SET IsMale = true WHERE uid = ",num_to_str(new_u->uid),";",NULL);    else        sql_ = str_cat("UPDATE user SET IsMale = false WHERE uid = ",num_to_str(new_u->uid),";",NULL);    rc = db_exec(sql_,0,0);    if(!rc) return 0;    return 1;}/* 读取用户密码 * SELECT * FROM user WHERE sid = '******' ; * 返回加密的密码字符串，需要将输入的密码字符串加密后进行比对 * * 使用方法：接收加密的密码的字符串名 = user_get_password(学号); */char * user_get_password(int sid){    User_result * check;    check = user_query(sid);    if(!check) return NULL;    char *pwd,*sql_;    pwd = (char*)malloc(sizeof(char));    int rc;    sql_ = str_cat("SELECT * FROM user WHERE sid = '",num_to_str(sid),"' ;",NULL);    rc = db_exec(sql_,call_password,pwd);    if(!rc) return NULL;    return pwd;}/* 修改用户密码 * UPDATE user SET password = '******' WHERE sid = ******; * 支持管理员改密和个人改密，个人改密请给sid赋0，管理员改密需要相应权限 *  * 使用方法：user_change_password(密码明文,学号); */int user_change_password(char *pwd,int _sid){    if(_sid!=0&&(!ua.Allow_Manage_Other_User_info||!ua.Allow_User_info_Write)) return -1;    char *sql_,*pwd_,*sid_;    pwd_ = xor_crypt(pwd,KEY);    if(_sid==0)        sid_ = num_to_str(Login_User->sid);    else        sid_ = num_to_str(_sid);    sql_ = str_cat("UPDATE user SET password = '",pwd_,"' WHERE sid = ",sid_," ;",NULL);    return db_exec(sql_,0,0);}/* 修改用户记录 * UPDATE user SET ****** = '******' WHERE uid = ******; * ！传入的字段值必须先转换为字符串 * ！此函数不能用来修改密码 * * 使用方法：user_sql_edit(用户ID,要改的字段名,字段值); */int user_sql_edit(User *obj,char *key,char *value){    if(!ua.Allow_Manage_Other_User_info||!ua.Allow_User_info_Write)        return -1;    char *sql_;    int rc;//--BEGIN- 同用户组下用户的重复检查    User_result * check;    check = user_query(obj->sid);//---END-- 同用户组下用户的重复检查    if(!user_check(obj->uid)) return 3;    if(strcmp(key,"uname")==0)        sql_ = str_cat("UPDATE user SET uname = '", value, "' WHERE sid = ", num_to_str(obj->sid), ";", NULL);    else if(strcmp(key,"gid")==0){        if (user_get(0, check, obj->gid)) return 4;        sql_ = str_cat("UPDATE user SET gid = ", value, " WHERE sid = ", num_to_str(obj->sid), ";", NULL);    }else if(strcmp(key,"sid")==0){        if(user_query(str_to_num(value))->n==NULL) return 4;        sql_ = str_cat("UPDATE user SET sid = ", value, " WHERE sid = ", num_to_str(obj->sid), ";", NULL);    }else if(strcmp(key,"IsMale")==0)        sql_ = str_cat("UPDATE user SET IsMale = ",value," WHERE sid = ",num_to_str(obj->sid),";",NULL);    else if(strcmp(key,"mask")==0)        sql_ = str_cat("UPDATE user SET mask = ",value," WHERE sid = ",num_to_str(obj->sid),";",NULL);    else        return 0;    rc = db_exec(sql_,0,0);    result_user_delete(check);    if(!rc) return 0;    return 1;}/* 删除用户记录 * DELETE FROM user WHERE uid = ******; * * 使用方法：user_sql_delete(用户ID); */int user_sql_delete(int uid){    if(!ua.Allow_User_info_Delete||!ua.Allow_Manage_Other_User_info)        return -1;    char *sql_;    if(!user_check(uid)) return 3;    sql_ = str_cat("DELETE FROM user WHERE uid = ",num_to_str(uid),";",NULL);    return db_exec(sql_,0,0);}/* 用户自行修改用户记录 * ！传入的字段值必须先转换为字符串 * 需要拥有修改用户信息权限TIPS： * 由Allow_User_info_Write权限和Allow_Self_Change_Info系统开关控制 * 如果Allow_Self_Change_Info关闭，将强制所有用户不能修改自己除用户名以外的用户信息 * 如果Allow_User_info_Write权限被关闭，将禁止用户修改自己的任何信息 * * 使用方法：user_self_edit(要改的字段名,字段值); */int user_self_edit(char *key,char *value){    if(!ua.Allow_User_info_Write) return -1;    char *sql_;    int rc;//--BEGIN- 同用户组下用户的重复检查    User_result * check;    check = user_query(Login_User->sid);//---END-- 同用户组下用户的重复检查    if(!user_check(Login_User->uid)) return 3;    if(strcmp(key,"uname")==0)        sql_ = str_cat("UPDATE user SET uname = '", value, "' WHERE sid = ", num_to_str(Login_User->sid), ";", NULL);    else if(strcmp(key,"gid")==0)        sql_ = str_cat("UPDATE user SET gid = ",value," WHERE sid = ",num_to_str(Login_User->sid),";",NULL);    else if(strcmp(key,"sid")==0){        if(user_get(0,check,Login_User->gid)) return 4;        sql_ = str_cat("UPDATE user SET sid = ", value, " WHERE sid = ", num_to_str(Login_User->sid), ";", NULL);    }else if(strcmp(key,"IsMale")==0)        sql_ = str_cat("UPDATE user SET IsMale = ",value," WHERE sid = ",num_to_str(Login_User->sid),";",NULL);    else if(strcmp(key,"mask")==0)        sql_ = str_cat("UPDATE user SET mask = ",value," WHERE sid = ",num_to_str(Login_User->sid),";",NULL);    else        return 0;    rc = db_exec(sql_,0,0);    result_user_delete(check);    if(!rc) return 0;    return 1;}/* 查询用户记录 * ！学号，用户名，用户组ID如不在搜索范围内，请赋0或NULL值 * ！性别如不在搜索范围内，请赋负值 * 对学号和用户名采用模糊搜索 * * 使用方法：user_sql_query(用户链表名,学号,用户名,用户组ID,性别,权限掩码); */int user_sql_query(User_result *result,int sid,char *uname,int gid,int IsMale){    if(!ua.Allow_Book_info_Read||!ua.Allow_Manage_Other_User_info) return -1;    int rc;    char *sql_,*where;    where = str_cat("WHERE uname LIKE '%",uname,"%' ",NULL);    if(sid!=0)        where = str_cat(where,"AND sid LIKE '%",num_to_str(sid),"%' ",NULL);    if(gid!=0)        where = str_cat(where,"AND gid = ",num_to_str(gid)," ",NULL);    if(IsMale>=0)        where = str_cat(where,"AND IsMale = ",IsMale?"true":"false"," ",NULL);    sql_ = str_cat("SELECT * FROM user ",where,";",NULL);    rc = db_exec(sql_,call_user,result);    return rc;}